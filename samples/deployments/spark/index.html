
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="PII anonymization for text and images." name="description"/>
<meta content="Microsoft" name="author"/>
<link href="https://microsoft.github.io/presidio/samples/deployments/spark/" rel="canonical"/>
<link href="../../../assets/ms_icon.png" rel="icon"/>
<meta content="mkdocs-1.2.2, mkdocs-material-7.3.1" name="generator"/>
<title>Azure Databricks/Spark - Microsoft Presidio</title>
<link href="../../../assets/stylesheets/main.1c75ef36.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.3f5d1f46.min.css" rel="stylesheet"/>
<meta content="#546d78" name="theme-color"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
<script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "5pd40fk720");
</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="blue-grey" data-md-color-scheme="default" dir="ltr">
<script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#anonymize-pii-using-presidio-on-spark">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Microsoft Presidio" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="Microsoft Presidio">
<img alt="logo" src="../../../assets/ms_icon.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Microsoft Presidio
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Azure Databricks/Spark
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/microsoft/presidio/" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Microsoft Presidio" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="Microsoft Presidio">
<img alt="logo" src="../../../assets/ms_icon.png"/>
</a>
    Microsoft Presidio
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/microsoft/presidio/" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
        Home
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../getting_started/">
        Getting Started
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../installation/">
        Installation
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4">
          Text anonymization
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Text anonymization" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
          Text anonymization
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../text_anonymization/">
        Home
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" id="__nav_4_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_2">
          Presidio Analyzer
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Presidio Analyzer" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_2">
<span class="md-nav__icon md-icon"></span>
          Presidio Analyzer
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../analyzer/">
        Analyzer Home
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_2" id="__nav_4_2_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_2_2">
          Developing PII recognizers
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Developing PII recognizers" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_4_2_2">
<span class="md-nav__icon md-icon"></span>
          Developing PII recognizers
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../analyzer/adding_recognizers/">
        Tutorial
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../analyzer/developing_recognizers/">
        Best practices in developing recognizers
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../analyzer/languages/">
        Multi-language support
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../analyzer/customizing_nlp_models/">
        Customizing the NLP model
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../analyzer/decision_process/">
        Tracing the decision process
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3" id="__nav_4_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_3">
          Presidio Anonymizer
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Presidio Anonymizer" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_3">
<span class="md-nav__icon md-icon"></span>
          Presidio Anonymizer
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../anonymizer/">
        Anonymizer Home
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../anonymizer/adding_operators/">
        Developing PII operators
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5">
          Image Redactor
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Image Redactor" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
          Image Redactor
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../image-redactor/">
        Home
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6">
          Samples
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Samples" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
          Samples
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../">
        Samples Home
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../python/">
        Python
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../docker/">
        Docker
      </a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4" id="__nav_6_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_6_4">
          Sample Deployments
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Sample Deployments" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_6_4">
<span class="md-nav__icon md-icon"></span>
          Sample Deployments
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../app-service/">
        Azure App Service
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../k8s/">
        Kubernetes
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          Azure Databricks/Spark
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        Azure Databricks/Spark
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#the-basics-of-working-with-presidio-in-spark">
    The basics of working with Presidio in Spark
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pre-requisites">
    Pre-requisites
  </a>
<nav aria-label="Pre-requisites" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#deploy-infrastructure">
    Deploy Infrastructure
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setup-databricks">
    Setup Databricks
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#configure-an-existing-cluster">
    Configure an existing cluster
  </a>
<nav aria-label="Configure an existing cluster" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#set-up-secret-scope-and-secrets-for-storage-account">
    Set up secret scope and secrets for storage account
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#upload-or-update-cluster-init-scripts">
    Upload or update cluster init scripts
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#upload-presidio-notebooks">
    Upload presidio notebooks
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#update-cluster-environment">
    Update cluster environment
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mount-the-storage-container">
    Mount the storage container
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#running-the-sample">
    Running the sample
  </a>
<nav aria-label="Running the sample" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#configure-presidio-transformation-notebook">
    Configure Presidio transformation notebook
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#run-the-notebook">
    Run the notebook
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../data-factory/">
        Azure Data Factory
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../supported_entities/">
        Supported entities
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" id="__nav_8" type="checkbox"/>
<label class="md-nav__link" for="__nav_8">
          Development and design
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Development and design" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_8">
<span class="md-nav__icon md-icon"></span>
          Development and design
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../design/">
        Design
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../development/">
        Setting up a development environment
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../build_release/">
        Build and release process
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../presidio_V2/">
        Changes from V1 to V2
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8_5" id="__nav_8_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_8_5">
          Python API reference
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Python API reference" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_8_5">
<span class="md-nav__icon md-icon"></span>
          Python API reference
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../api/analyzer_python/">
        Presidio Analyzer Python API
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../api/anonymizer_python/">
        Presidio Anonymizer Python API
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../api/image_redactor_python/">
        Presidio Image Redactor Python API
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="https://microsoft.github.io/presidio/api-docs/api-docs.html" target="_blank">
        REST API reference
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#the-basics-of-working-with-presidio-in-spark">
    The basics of working with Presidio in Spark
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pre-requisites">
    Pre-requisites
  </a>
<nav aria-label="Pre-requisites" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#deploy-infrastructure">
    Deploy Infrastructure
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setup-databricks">
    Setup Databricks
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#configure-an-existing-cluster">
    Configure an existing cluster
  </a>
<nav aria-label="Configure an existing cluster" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#set-up-secret-scope-and-secrets-for-storage-account">
    Set up secret scope and secrets for storage account
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#upload-or-update-cluster-init-scripts">
    Upload or update cluster init scripts
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#upload-presidio-notebooks">
    Upload presidio notebooks
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#update-cluster-environment">
    Update cluster environment
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mount-the-storage-container">
    Mount the storage container
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#running-the-sample">
    Running the sample
  </a>
<nav aria-label="Running the sample" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#configure-presidio-transformation-notebook">
    Configure Presidio transformation notebook
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#run-the-notebook">
    Run the notebook
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="anonymize-pii-using-presidio-on-spark">Anonymize PII using Presidio on Spark</h1>
<p>You can leverages presidio to perform data anonymization as part of spark notebooks.</p>
<p>The following sample uses <a href="https://docs.microsoft.com/en-us/azure/databricks/">Azure Databricks</a> and simple text files hosted on <a href="https://docs.microsoft.com/en-us/azure/storage/blobs/">Azure Blob Storage</a>. However, it can easily change to fit any other scenario which requires PII analysis or anonymization as part of spark jobs.</p>
<p><strong>Note</strong> that this code works for Databricks runtime 8.1 (spark 3.1.1) and the libraries described <a href="https://docs.microsoft.com/en-us/azure/databricks/release-notes/runtime/8.1">here</a>.</p>
<h2 id="the-basics-of-working-with-presidio-in-spark">The basics of working with Presidio in Spark</h2>
<p>A typical use case of Presidio in Spark is transforming a text column in a data frame, by anonymizing its content. The following code sample, a part of <a href="notebooks/01_transform_presidio/">transform presidio notebook</a>, is the basis of the e2e sample which uses Azure Databricks as the Spark environment.</p>
<div class="highlight"><pre><span></span><code><span class="n">anonymized_column</span> <span class="o">=</span> <span class="s2">"value"</span> <span class="c1"># name of column to anonymize</span>
<span class="n">analyzer</span> <span class="o">=</span> <span class="n">AnalyzerEngine</span><span class="p">()</span>
<span class="n">anonymizer</span> <span class="o">=</span> <span class="n">AnonymizerEngine</span><span class="p">()</span>

<span class="c1"># broadcast the engines to the cluster nodes</span>
<span class="n">broadcasted_analyzer</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">analyzer</span><span class="p">)</span>
<span class="n">broadcasted_anonymizer</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">anonymizer</span><span class="p">)</span>

<span class="c1"># define a pandas UDF function and a series function over it.</span>
<span class="k">def</span> <span class="nf">anonymize_text</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">analyzer</span> <span class="o">=</span> <span class="n">broadcasted_analyzer</span><span class="o">.</span><span class="n">value</span>
    <span class="n">anonymizer</span> <span class="o">=</span> <span class="n">broadcasted_anonymizer</span><span class="o">.</span><span class="n">value</span>
    <span class="n">analyzer_results</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="s2">"en"</span><span class="p">)</span>
    <span class="n">anonymized_results</span> <span class="o">=</span> <span class="n">anonymizer</span><span class="o">.</span><span class="n">anonymize</span><span class="p">(</span>
        <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
        <span class="n">analyzer_results</span><span class="o">=</span><span class="n">analyzer_results</span><span class="p">,</span>
        <span class="n">operators</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">"DEFAULT"</span><span class="p">:</span> <span class="n">OperatorConfig</span><span class="p">(</span><span class="s2">"replace"</span><span class="p">,</span> <span class="p">{</span><span class="s2">"new_value"</span><span class="p">:</span> <span class="s2">"&lt;ANONYMIZED&gt;"</span><span class="p">})</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">anonymized_results</span><span class="o">.</span><span class="n">text</span>


<span class="k">def</span> <span class="nf">anonymize_series</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">anonymize_text</span><span class="p">)</span>


<span class="c1"># define a the function as pandas UDF</span>
<span class="n">anonymize</span> <span class="o">=</span> <span class="n">pandas_udf</span><span class="p">(</span><span class="n">anonymize_series</span><span class="p">,</span> <span class="n">returnType</span><span class="o">=</span><span class="n">StringType</span><span class="p">())</span>

<span class="c1"># apply the udf</span>
<span class="n">anonymized_df</span> <span class="o">=</span> <span class="n">input_df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
    <span class="n">anonymized_column</span><span class="p">,</span> <span class="n">anonymize</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="n">anonymized_column</span><span class="p">))</span>
<span class="p">)</span>
</code></pre></div>
<h2 id="pre-requisites">Pre-requisites</h2>
<p>If you do not have an instance of Azure Databricks, follow through with the following steps to provision and setup the required infrastrucutre.</p>
<p>If you do have a Databricks workspace and a cluster you wish to configure to run Presidio, jump over to the <a href="#Configure-an-existing-cluster">Configure an existing cluster</a> section.</p>
<h3 id="deploy-infrastructure">Deploy Infrastructure</h3>
<p>Provision the Azure resources by running the following script.</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">RESOURCE_GROUP</span><span class="o">=[</span>resource group name<span class="o">]</span>
<span class="nb">export</span> <span class="nv">STORAGE_ACCOUNT_NAME</span><span class="o">=[</span>storage account name<span class="o">]</span>
<span class="nb">export</span> <span class="nv">STORAGE_CONTAINER_NAME</span><span class="o">=[</span>blob container name<span class="o">]</span>
<span class="nb">export</span> <span class="nv">DATABRICKS_WORKSPACE_NAME</span><span class="o">=[</span>databricks workspace name<span class="o">]</span>
<span class="nb">export</span> <span class="nv">DATABRICKS_SKU</span><span class="o">=[</span>basic/standard/premium<span class="o">]</span>
<span class="nb">export</span> <span class="nv">LOCATION</span><span class="o">=[</span>location<span class="o">]</span>

<span class="c1"># Create the resource group</span>
az group create --name <span class="nv">$RESOURCE_GROUP</span> --location <span class="nv">$LOCATION</span>

<span class="c1"># Use ARM template to build the resources and get back the workspace URL</span>
<span class="nv">deployment_response</span><span class="o">=</span><span class="k">$(</span>az deployment group create -g <span class="nv">$RESOURCE_GROUP</span> --template-file ./docs/samples/deployments/spark/arm-template/databricks.json  --parameters <span class="nv">location</span><span class="o">=</span><span class="nv">$LOCATION</span> <span class="nv">workspaceName</span><span class="o">=</span><span class="nv">$DATABRICKS_WORKSPACE_NAME</span> <span class="nv">storageAccountName</span><span class="o">=</span><span class="nv">$STORAGE_ACCOUNT_NAME</span> <span class="nv">containerName</span><span class="o">=</span><span class="nv">$STORAGE_CONTAINER_NAME</span><span class="k">)</span>

<span class="nb">export</span> <span class="nv">DATABRICKS_WORKSPACE_URL</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$deployment_response</span> <span class="p">|</span> jq -r <span class="s2">".properties.outputs.workspaceUrl.value"</span><span class="k">)</span>
<span class="nb">export</span> <span class="nv">DATABRICKS_WORKSPACE_ID</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$deployment_response</span> <span class="p">|</span> jq -r <span class="s2">".properties.outputs.workspaceId.value"</span><span class="k">)</span>
</code></pre></div>
<h3 id="setup-databricks">Setup Databricks</h3>
<p>The following script will setup a new cluster in the databricks workspace and prepare it to run presidio anonymization jobs.
Once finished, the script will output an access key which you can use when working with databricks cli.</p>
<div class="highlight"><pre><span></span><code>sh ./scripts/configure_databricks.sh
</code></pre></div>
<h3 id="configure-an-existing-cluster">Configure an existing cluster</h3>
<p>Only follow through with the steps in this section if you have an existing databricks workspace and clsuter you wish to configure to run presidio. If you've followed through with the "Deploy Infrastructure" and "Setup Databricks" sections you do not have to run the script in this section.</p>
<h4 id="set-up-secret-scope-and-secrets-for-storage-account">Set up secret scope and secrets for storage account</h4>
<p>Add an Azure Storage account key to secret scope.</p>
<div class="highlight"><pre><span></span><code><span class="nv">STORAGE_PRIMARY_KEY</span><span class="o">=[</span>Primary key of storage account<span class="o">]</span>

databricks secrets create-scope --scope storage_scope --initial-manage-principal users
databricks secrets put --scope storage_scope --key storage_account_access_key --string-value <span class="s2">"</span><span class="nv">$STORAGE_PRIMARY_KEY</span><span class="s2">"</span>
</code></pre></div>
<h4 id="upload-or-update-cluster-init-scripts">Upload or update cluster init scripts</h4>
<p>Presidio libraries are loaded to the cluster on init.
Upload the cluster setup script or add its content to the existing cluster's init script.</p>
<div class="highlight"><pre><span></span><code>databricks fs cp <span class="s2">"./setup/startup.sh"</span> <span class="s2">"dbfs:/FileStore/dependencies/startup.sh"</span>
</code></pre></div>
<p>Setup the cluster to run the <a href="https://docs.microsoft.com/en-us/azure/databricks/clusters/configure#init-scripts">init script</a>.</p>
<h4 id="upload-presidio-notebooks">Upload presidio notebooks</h4>
<div class="highlight"><pre><span></span><code>databricks workspace import_dir <span class="s2">"./notebooks"</span> <span class="s2">"/notebooks"</span> --overwrite
</code></pre></div>
<h4 id="update-cluster-environment">Update cluster environment</h4>
<p>Add the following <a href="https://docs.microsoft.com/en-us/azure/databricks/clusters/configure#environment-variables">environment variables</a> to your databricks cluster:</p>
<div class="highlight"><pre><span></span><code><span class="s2">"STORAGE_MOUNT_NAME"</span>: <span class="s2">"/mnt/files"</span>
<span class="s2">"STORAGE_CONTAINER_NAME"</span>: <span class="o">[</span>Blob container name<span class="o">]</span>
<span class="s2">"STORAGE_ACCOUNT_NAME"</span>: <span class="o">[</span>Storage account name<span class="o">]</span>
</code></pre></div>
<h4 id="mount-the-storage-container">Mount the storage container</h4>
<p>Run the notebook 00_setup to mount the storage account to databricks.</p>
<h2 id="running-the-sample">Running the sample</h2>
<h3 id="configure-presidio-transformation-notebook">Configure Presidio transformation notebook</h3>
<p>From Databricks workspace, under notebooks folder, open the provided 01_transform_presidio notebook and attach it to the cluster preisidio_cluster.
Run the first code-cell and note the following parameters on the top end of the notebook (notebook widgets) and set them accordingly</p>
<ul>
<li>Input File Format - text (selected).</li>
<li>Input path - a folder on the container where input files are found.</li>
<li>Output Folder - a folder on the container where output files will be written to.</li>
<li>Column to Anonymize - value (selected).</li>
</ul>
<h3 id="run-the-notebook">Run the notebook</h3>
<p>Upload a text file to the blob storage input folder, using any preferd method (<a href="https://docs.microsoft.com/en-us/azure/storage/blobs/storage-quickstart-blobs-portal">Azure Portal</a>, <a href="https://docs.microsoft.com/en-us/azure/storage/blobs/storage-quickstart-blobs-storage-explorer">Azure Storage Explorer</a>, <a href="https://docs.microsoft.com/en-us/azure/storage/blobs/storage-quickstart-blobs-cli">Azure CLI</a>).</p>
<div class="highlight"><pre><span></span><code>az storage blob upload --account-name <span class="nv">$STORAGE_ACCOUNT_NAME</span>  --container <span class="nv">$STORAGE_CONTAINER_NAME</span> --file ./<span class="o">[</span>file name<span class="o">]</span> --name input/<span class="o">[</span>file name<span class="o">]</span>
</code></pre></div>
<p>Run the notebook cells, the output should be csv files which contain two columns, the original file name, and the anonymized content of that file.</p>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<nav aria-label="Footer" class="md-footer__inner md-grid">
<a aria-label="Previous: Kubernetes" class="md-footer__link md-footer__link--prev" href="../k8s/" rel="prev">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</div>
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Previous
              </span>
              Kubernetes
            </div>
</div>
</a>
<a aria-label="Next: Azure Data Factory" class="md-footer__link md-footer__link--next" href="../data-factory/" rel="next">
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Next
              </span>
              Azure Data Factory
            </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
            Material for MkDocs
          </a>
</div>
<div class="md-footer-social">
<a class="md-footer-social__link" href="https://github.com/microsoft/presidio" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</a>
<a class="md-footer-social__link" href="https://hub.docker.com/_/microsoft-presidio" rel="noopener" target="_blank" title="hub.docker.com">
<svg viewbox="0 0 640 512" xmlns="http://www.w3.org/2000/svg"><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"></path></svg>
</a>
<a class="md-footer-social__link" href="mailto:presidio@microsoft.com" rel="noopener" target="_blank" title="">
<svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.e99e714c.min.js", "version": null}</script>
<script src="../../../assets/javascripts/bundle.c7d1b464.min.js"></script>
</body>
</html>